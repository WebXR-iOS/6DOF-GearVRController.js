/**
 * @author crazyh / https://github.com/crazyh2
 * @license Attribution-NonCommercial-ShareAlike 4.0 International
 */

/**
 * @author cwig / https://github.com/cwig
 * @license MIT License
 */

/**
 * @author jsyang / https://github.com/jsyang
 * @license GPL-3.0 License
 */

(()=>{"use strict";require_ahrs=function t(e,i,n){function a(o,s){if(!i[o]){if(!e[o]){if(r)return r(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var h=i[o]={exports:{}};e[o][0].call(h.exports,(function(t){return a(e[o][1][t]||t)}),h,h.exports,t,e,i,n)}return i[o].exports}for(var r=void 0,o=0;o<n.length;o++)a(n[o]);return a}({"./Madgwick":[function(t,e,i){e.exports=function(t,e){var i=1e3/t,n=(e=e||{}).beta||1,a=1,r=0,o=0,s=0,c=1/i;return{update:function(t,e,i,h,l,u,f,M,d,g){var v,A,C,b,m,p,w,E,y,_,S,I,D,V,O,U,R,x,F,T,B,N,L,W,P,k,z,G,Y,q,Q,K,X,H,Z;c=g||c,void 0===f||void 0===M||void 0===d||0===f&&0===M&&0===d?function(t,e,i,h,l,u){var f,M,d,g,v,A,C,b,m,p,w,E,y,_,S,I,D,V,O,U,R,x;A=.5*(-r*t-o*e-s*i),C=.5*(a*t+o*i-s*e),b=.5*(a*e-r*i+s*t),m=.5*(a*i+r*e-o*t),0===h&&0===l&&0===u||(f=Math.pow(h*h+l*l+u*u,-.5),M=(_=4*a)*(R=o*o)+(E=2*o)*(h*=f)+_*(U=r*r)-(w=2*r)*(l*=f),d=(S=4*r)*(x=s*s)-(y=2*s)*h+4*(O=a*a)*r-(p=2*a)*l-S+(D=8*r)*U+D*R+S*(u*=f),g=4*O*o+p*h+(I=4*o)*x-y*l-I+(V=8*o)*U+V*R+I*u,v=4*U*s-w*h+4*R*s-E*l,f=Math.pow(M*M+d*d+g*g+v*v,-.5),A-=n*(M*=f),C-=n*(d*=f),b-=n*(g*=f),m-=n*(v*=f)),a+=A*c,r+=C*c,o+=b*c,s+=m*c,f=Math.pow(a*a+r*r+o*o+s*s,-.5),a*=f,r*=f,o*=f,s*=f}(t,e,i,h,l,u):(p=.5*(-r*t-o*e-s*i),w=.5*(a*t+o*i-s*e),E=.5*(a*e-r*i+s*t),y=.5*(a*i+r*e-o*t),0===h&&0===l&&0===u||(h*=v=Math.pow(h*h+l*l+u*u,-.5),l*=v,u*=v,v=Math.pow(f*f+M*M+d*d,-.5),T=2*a,L=2*s,W=2*a*o,P=2*o*s,z=a*r,G=a*o,Y=a*s,Q=r*o,K=r*s,H=o*s,_=(f*=v)*(k=a*a)-(D=2*a*(M*=v))*s+(V=2*a*(d*=v))*o+f*(q=r*r)+(B=2*r)*M*o+B*d*s-f*(X=o*o)-f*(Z=s*s),S=(I=2*a*f)*s+M*k-V*r+(O=2*r*f)*o-M*q+M*X+(N=2*o)*d*s-M*Z,U=Math.sqrt(_*_+S*S),A=-N*(2*K-W-h)+B*(2*z+P-l)-(R=-I*o+D*r+d*k+O*s-d*q+N*M*s-d*X+d*Z)*o*(U*(.5-X-Z)+R*(K-G)-f)+(-U*s+R*r)*(U*(Q-Y)+R*(z+H)-M)+U*o*(U*(G+K)+R*(.5-q-X)-d),C=L*(2*K-W-h)+T*(2*z+P-l)-4*r*(1-2*q-2*X-u)+R*s*(U*(.5-X-Z)+R*(K-G)-f)+(U*o+R*a)*(U*(Q-Y)+R*(z+H)-M)+(U*s-(F=2*R)*r)*(U*(G+K)+R*(.5-q-X)-d),b=-T*(2*K-W-h)+L*(2*z+P-l)-4*o*(1-2*q-2*X-u)+(-(x=2*U)*o-R*a)*(U*(.5-X-Z)+R*(K-G)-f)+(U*r+R*s)*(U*(Q-Y)+R*(z+H)-M)+(U*a-F*o)*(U*(G+K)+R*(.5-q-X)-d),m=B*(2*K-W-h)+N*(2*z+P-l)+(-x*s+R*r)*(U*(.5-X-Z)+R*(K-G)-f)+(-U*a+R*o)*(U*(Q-Y)+R*(z+H)-M)+U*r*(U*(G+K)+R*(.5-q-X)-d),v=Math.pow(A*A+C*C+b*b+m*m,-.5),p-=n*(A*=v),w-=n*(C*=v),E-=n*(b*=v),y-=n*(m*=v)),a+=p*c,r+=w*c,o+=E*c,s+=y*c,v=Math.pow(a*a+r*r+o*o+s*s,-.5),a*=v,r*=v,o*=v,s*=v)},getQuaternion:function(){return{w:a,x:r,y:o,z:s}}}}},{}],"./Mahony":[function(t,e,i){e.exports=function(t,e){var i=(e=e||{}).kp||1,n=e.ki||0,a=1/(1e3/t),r=2*i,o=2*n,s=1,c=0,h=0,l=0,u=0,f=0,M=0;return{update:function(t,e,i,n,d,g,v,A,C,b){var m,p,w,E,y,_,S,I,D,V,O,U,R,x,F,T,B,N,L,W,P,k,z,G,Y,q;a=b||a,void 0===v||void 0===A||void 0===C||0===v&&0===A&&0===C?function(t,e,i,n,d,g){var v,A,C,b,m,p,w,E,y,_;0!==n&&0!==d&&0!==g&&(m=(d*=v=Math.pow(n*n+d*d+g*g,-.5))*(b=s*s-.5+l*l)-(g*=v)*(C=s*c+h*l),p=g*(A=c*l-s*h)-(n*=v)*b,w=n*C-d*A,o>0?(t+=u+=o*m*a,e+=f+=o*p*a,i+=M+=o*w*a):(u=0,f=0,M=0),t+=r*m,e+=r*p,i+=r*w),E=s,s+=-(y=c)*(t*=.5*a)-(_=h)*(e*=.5*a)-l*(i*=.5*a),c+=E*t+_*i-l*e,h+=E*e-y*i+l*t,l+=E*i+y*e-_*t,v=Math.pow(s*s+c*c+h*h+l*l,-.5),s*=v,c*=v,h*=v,l*=v}(t,e,i,n,d,g):(0!==n&&0!==d&&0!==g&&(n*=m=Math.pow(n*n+d*d+g*g,-.5),d*=m,g*=m,O=2*((v*=m=Math.pow(v*v+A*A+C*C,-.5))*(.5-(I=h*h)-(V=l*l))+(A*=m)*((_=c*h)-(E=s*l))+(C*=m)*((S=c*l)+(w=s*h))),U=2*(v*(_+E)+A*(.5-(y=c*c)-V)+C*((D=h*l)-(p=s*c))),P=d*(B=s*s-.5+V)-g*(T=p+D)+(A*(W=(R=Math.sqrt(O*O+U*U))*(w+S)+(x=2*(v*(S-w)+A*(D+p)+C*(.5-y-I)))*(.5-y-I))-C*(L=R*(_-E)+x*(p+D))),k=g*(F=S-w)-n*B+(C*(N=R*(.5-I-V)+x*(S-w))-v*W),z=n*T-d*F+(v*L-A*N),o>0?(t+=u+=o*P*a,e+=f+=o*k*a,i+=M+=o*z*a):(u=0,f=0,M=0),t+=r*P,e+=r*k,i+=r*z),G=s,s+=-(Y=c)*(t*=.5*a)-(q=h)*(e*=.5*a)-l*(i*=.5*a),c+=G*t+q*i-l*e,h+=G*e-Y*i+l*t,l+=G*i+Y*e-q*t,m=Math.pow(s*s+c*c+h*h+l*l,-.5),s*=m,c*=m,h*=m,l*=m)},getQuaternion:function(){return{w:s,x:c,y:h,z:l}}}}},{}],ahrs:[function(t,e,i){var n=180/Math.PI;function a(e){var i,n=(e=e||{}).sampleInterval||20,a=e.algorithm||"Madgwick";if("Mahony"===a)i=new(t("./Mahony"))(n,e);else{if("Madgwick"!==a)throw new Error("AHRS(): Algorithm not valid: ",a);i=new(t("./Madgwick"))(n,e)}for(var r in i)i.hasOwnProperty(r)&&(this[r]=i[r])}a.prototype.toVector=function(){var t=this.getQuaternion(),e=2*Math.acos(t.w),i=Math.sin(e/2);return{angle:e,x:t.x/i,y:t.y/i,z:t.z/i}},a.prototype.getEulerAngles=function(){var t=this.getQuaternion(),e=t.w*t.w,i=t.x*t.x,n=t.y*t.y,a=t.z*t.z;return{heading:Math.atan2(2*(t.x*t.y+t.z*t.w),i-n-a+e),pitch:-Math.asin(2*(t.x*t.z-t.y*t.w)),roll:Math.atan2(2*(t.y*t.z+t.x*t.w),-i-n+a+e)}},a.prototype.getEulerAnglesDegrees=function(){var t=this.getEulerAngles();return{heading:t.heading*n,pitch:t.pitch*n,roll:t.roll*n}},e.exports=a},{"./Madgwick":"./Madgwick","./Mahony":"./Mahony"}]},{},[]);class t{constructor(t,e){this.gattServer=null,this.batteryService=null,this.deviceInformationService=null,this.customService=null,this.customServiceNotify=null,this.customServiceWrite=null,this.pair=this.pair.bind(this),this.disconnect=this.disconnect.bind(this),this.runCommand=this.runCommand.bind(this),this.onDeviceConnected=this.onDeviceConnected.bind(this),this.onNotificationReceived=this.onNotificationReceived.bind(this),e&&(this.onDeviceDisconnected=e.bind(this)),t&&(this.onControllerDataReceived=t.bind(this)),this.calibrating=!1,this.calibrationValues=null,this.calibrationCount=0,this.controllerAngle=Math.PI/180*-30}onDeviceConnected(t){return this.onDeviceDisconnected&&t.addEventListener("gattserverdisconnected",onDeviceDisconnected),t.gatt.connect()}pair(){return navigator.bluetooth.requestDevice({acceptAllDevices:!1,filters:[{namePrefix:"Gear VR Controller"}],optionalServices:[t.UUID_CUSTOM_SERVICE]}).then(this.onDeviceConnected).then((t=>this.gattServer=t)).then((()=>this.gattServer.getPrimaryService(t.UUID_CUSTOM_SERVICE))).then((t=>this.customService=t)).then((()=>this.customService.getCharacteristic(t.UUID_CUSTOM_SERVICE_WRITE).then((t=>this.customServiceWrite=t)))).then((()=>this.customService.getCharacteristic(t.UUID_CUSTOM_SERVICE_NOTIFY).then((t=>this.customServiceNotify=t)))).then((()=>this.customServiceNotify.startNotifications().then((()=>this.customServiceNotify.addEventListener("characteristicvaluechanged",this.onNotificationReceived)))))}disconnect(){this.gattServer&&this.gattServer.disconnect()}onNotificationReceived(e){const{buffer:i}=e.target.value,n=new Uint8Array(i);if(60!==n.length)return;const a=((15&n[54])<<6)+((252&n[55])>>2)&1023,r=((3&n[55])<<8)+((255&n[56])>>0)&1023,o=(4294967295&new Int32Array(i.slice(0,4))[0])/1e3*t.TIMESTAMP_FACTOR,s=n[57],{getAccelerometerFloatWithOffsetFromArrayBufferAtIndex:c,getGyroscopeFloatWithOffsetFromArrayBufferAtIndex:h,getMagnetometerFloatWithOffsetFromArrayBufferAtIndex:l}=t,u=[c(i,4,0),c(i,6,0),c(i,8,0)].map((e=>e*t.ACCEL_FACTOR)),f=[h(i,10,0),h(i,12,0),h(i,14,0)].map((e=>e*t.GYRO_FACTOR));let M=l(i,0),d=l(i,2),g=l(i,4);const v=Boolean(1&n[58]),A=Boolean(2&n[58]),C=Boolean(4&n[58]),b=Boolean(8&n[58]),m=Boolean(16&n[58]),p=Boolean(32&n[58]);!this.calibrating&&v&&C&&(this.calibrating=!0,this.calibrationValues=[1e8,-1e8,1e8,-1e8,1e8,-1e8],this.calibrationCount=0),!this.calibrating||v||C||(this.calibrating=!1),this.calibrating&&(this.calibrationCount+=1,this.calibrationValues[0]=Math.min(M,this.calibrationValues[0]),this.calibrationValues[1]=Math.max(M,this.calibrationValues[1]),this.calibrationValues[2]=Math.min(d,this.calibrationValues[2]),this.calibrationValues[3]=Math.max(d,this.calibrationValues[3]),this.calibrationValues[4]=Math.min(g,this.calibrationValues[4]),this.calibrationValues[5]=Math.max(g,this.calibrationValues[5])),null!==this.calibrationValues&&this.calibrationCount>10&&(M=(M-this.calibrationValues[0])/(this.calibrationValues[1]-this.calibrationValues[0])-.5,d=(d-this.calibrationValues[2])/(this.calibrationValues[3]-this.calibrationValues[2])-.5,g=(g-this.calibrationValues[4])/(this.calibrationValues[5]-this.calibrationValues[4])-.5);let w=-M,E=d*Math.cos(this.controllerAngle)+-g*Math.sin(this.controllerAngle),y=d*Math.sin(this.controllerAngle)+g*Math.cos(this.controllerAngle);M=w,d=E,g=y,this.onControllerDataReceived({accel:u,gyro:f,magX:M,magY:d,magZ:g,timestamp:o,temperature:s,axisX:a,axisY:r,triggerButton:v,homeButton:A,backButton:C,touchpadButton:b,volumeUpButton:m,volumeDownButton:p})}runCommand(e){const{getLittleEndianUint8Array:i,onBluetoothError:n}=t;return this.customServiceWrite.writeValue(i(e)).catch(n)}}t.onBluetoothError=t=>{console.warn("Error: "+t)},t.UUID_CUSTOM_SERVICE="4f63756c-7573-2054-6872-65656d6f7465",t.UUID_CUSTOM_SERVICE_WRITE="c8c51726-81bc-483b-a052-f7a14ea3d282",t.UUID_CUSTOM_SERVICE_NOTIFY="c8c51726-81bc-483b-a052-f7a14ea3d281",t.CMD_OFF="0000",t.CMD_SENSOR="0100",t.CMD_UNKNOWN_FIRMWARE_UPDATE_FUNC="0200",t.CMD_CALIBRATE="0300",t.CMD_KEEP_ALIVE="0400",t.CMD_UNKNOWN_SETTING="0500",t.CMD_LPM_ENABLE="0600",t.CMD_LPM_DISABLE="0700",t.CMD_VR_MODE="0800",t.GYRO_FACTOR=1e-4,t.ACCEL_FACTOR=1e-5,t.TIMESTAMP_FACTOR=.001,t.getAccelerometerFloatWithOffsetFromArrayBufferAtIndex=(t,e,i)=>{const n=new Int16Array(t.slice(16*i+e,16*i+e+2));return new Float32Array([1e4*n[0]*9.80665/2048])[0]},t.getGyroscopeFloatWithOffsetFromArrayBufferAtIndex=(t,e,i)=>{const n=new Int16Array(t.slice(16*i+e,16*i+e+2));return new Float32Array([1e4*n[0]*.017453292/14.285])[0]},t.getMagnetometerFloatWithOffsetFromArrayBufferAtIndex=(t,e)=>{const i=new Int16Array(t.slice(48+e,48+e+2));return new Float32Array([.06*i[0]])[0]},t.getLength=(t,e,i)=>Math.sqrt(t**2+e**2+i**2),t.getLittleEndianUint8Array=t=>{const e=new Uint8Array(t.length>>1);for(let i=0,n=0;i+2<=t.length;i+=2,n++)e[n]=parseInt(t.substr(i,2),16);return e}})();
